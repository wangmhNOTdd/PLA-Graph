这个版本是DSAN-v2的最终形态，它不仅在块间交换信息时考虑3D距离，更在块内信息注入时考虑了原子的相对几何位置。

### **架构总览：DSAN-v2 with Geometry-Aware Cross-Attention**

该模型通过堆叠多个 **DSAN-v2层** 来学习分子复合物的表示。每一层都实现了从微观（原子）提炼宏观（块）信息，在宏观层面进行3D感知交互，最后将结果智能地、几何感知地反馈回微观层面。

---

### **第一部分：输入预处理与图构建 (不变)**

这一部分与之前的设计完全相同。

1. **功能块 (Blocks)**: 蛋白质为残基，配体为原子。
2. **原子初始特征**:

   * **标量特征 $H^{(0)}$**: `Embedding(化学属性)`。
   * **坐标特征 $X$**: 静态的三维坐标，仅用于计算距离和相对位置。
3. **块间图结构**:

   * 基于k-NN和最小原子距离构建，边属性为 `inter_edge_attr_ij = RBF(d_ij)`。

---

### **第二部分：核心计算单元 - 单个DSAN-v2层 (几何感知版)**

下面是第 `l` 层的详细计算流程，这是整个模型的核心。

**输入**: 上一层输出的各块原子特征 `{H_i^{(l-1)}}` 和静态的原子坐标 `{X_i}`。

#### **模块 1: 块级消息提取 (PMA)**

* **目的**: 从当前每个块的原子特征矩阵中，提炼出代表该块状态的、用于对外交互的单一特征向量。
* **流程**: 对每个块 `i` 并行执行：

  1. **输入**: `H_i^{(l-1)}`
  2. `m_i^{(l)} = mean(PMA(H_i^{(l-1)}, S))`，其中 `S` 是可学习的种子向量。
* **输出**: 所有块的特征向量集合 `{m_i^{(l)}}`。

#### **模块 2: 3D-Aware 块间信息交换 (ESA)**

* **目的**: 在块间图上，利用ESA机制，让每个块的特征向量 `m_i^{(l)}` 与其邻居进行3D感知的信-息交换。
* **流程**:

  1. **生成边特征**: 对于块间图中的每条有向边 `e_ij`：
     `h(e_ij)^(l) = Concat(m_i^{(l)}, inter_edge_attr_ij)`
  2. **运行ESA编码器**:

     * 将所有边特征 `{h(e_ij)^(l)}` 组成的集合送入ESA模块，得到更新后的边特征 `{h'(e_ij)^(l)}`。
  3. **聚合信息回块节点**: 对于每个块 `j`：

     * `m_j_update^(l) = Sum({h'(e_ij)^(l) | for all i that connect to j})`
     * `m_j'^(l) = LayerNorm(m_j^{(l)} + m_j_update^(l))`
* **输出**: 更新后的块级特征向量 `{m_j'^(l)}`，它包含了来自邻居块的丰富信息。

#### **模块 3: 几何感知的块内原子更新 (Geometry-Aware Cross-Attention)**

* **这是最终改进的核心！**
* **目的**: 将浓缩了邻域信息的块级特征 `m_j'^(l)`，智能地、有区别地“注入”到块 `j` 内部的每一个原子中，**这个注入过程将考虑每个原子的几何位置**。
* **流程**: 对每个块 `j` 并行执行：

  1. **输入**: 块 `j` 在**本层开始时**的原子特征 `H_j^{(l-1)}`、原子坐标 `X_j`，以及刚计算出的更新后块级特征 `m_j'^(l)`。
  2. **为每个原子生成块内几何特征**:

     * 计算块 `j` 的质心：`centroid_j = mean(X_j)`。
     * 对于块内的每个原子 `p`，计算其相对于质心的距离，并用RBF编码：
       `geom_feat_p = RBF(||X_j[p] - centroid_j||)`
  3. **准备几何感知的 Q, K, V**:

     * **Query**: 由块级特征生成。
       `Q = m_j'^(l) * W_Q` (大小: `1 x d`)
     * **Key, Value**: 由**增强后**的原子特征生成。
       `h_p_augmented = Concat(H_j^{(l-1)}[p], geom_feat_p)`
       `K_p = h_p_augmented * W_K`
       `V_p = h_p_augmented * W_V`
  4. **计算交叉注意力及更新**:

     * `scores = (Q @ K.T) / sqrt(d_k)`
     * `attention_weights = Softmax(scores)` (大小: `1 x n_j`)
     * `context_vector = attention_weights @ V` (大小: `1 x d`)
     * `atomic_update = MLP_fuse(context_vector)` (大小: `1 x d`)
     * `H_j_update = broadcast(atomic_update)` (大小: `n_j x d`)
     * `H_j^{(l)} = LayerNorm(H_j^{(l-1)} + H_j_update)`
     * `H_j^{(l)} = LayerNorm(H_j^{(l)} + MLP_ffn_atomic(H_j^{(l)}))`
* **输出**: 经过完整一轮更新的、本层最终的原子特征 `{H_j^{(l)}}`。

---

### **第三部分：模型收尾与预测 (不变)**

1. **堆叠DSAN-v2层**:

   * 将 L 个（例如 L=8）DSAN-v2（几何感知版）层顺序堆叠。
2. **全局读出 (Global Readout)**:

   * `h_graph = GlobalMeanPooling(Concat(H_1^(L), H_2^(L), ...))`
3. **预测头 (Prediction Head)**:

   * `affinity_value = MLP_final(h_graph)`

### **架构流程总结 (几何感知版)**

| 步骤               | 模块/操作                   | 输入                             | 输出                   | 目的与核心细节                           |
| :--------------- | :---------------------- | :----------------------------- | :------------------- | :-------------------------------- |
| 0                | **预处理**                 | PDB文件                          | `H^(0)`, `X`, 双层图结构  | 准备静态输入。                           |
| **DSAN-v2层 `l`** |                         |                                |                      | **重复 L 次**                        |
| 1.1              | **PMA**                 | `H_i^(l-1)`                    | 块级特征 `m_i^(l)`       | **尺度降低**。从原子到块。                   |
| 1.2              | **ESA**                 | `{m_i^(l)}` 和块间图               | 更新后的块级特征 `m_j'^(l)`  | **块间通信**。利用块间距离进行3D感知。            |
| 1.3              | **Geo-Cross-Attention** | `H_j^(l-1)`, `X_j`, `m_j'^(l)` | 本层最终原子特征 `H_j^{(l)}` | **几何感知的信息注入**。Key包含了原子在块内的相对位置信息。 |
| 2                | **全局读出**                | `{H_i^(L)}`                    | `h_graph`            | 聚合所有信息。                           |
| 3                | **预测头**                 | `h_graph`                      | 亲和力值                 | 输出最终预测。                           |

这个最终版本的 **DSAN-v2 (Geo-Cross-Attention)** 在理论上已经非常完善和强大。它成功地将ESA的拓扑学习能力与多尺度建模思想相结合，并通过在两个不同尺度上巧妙地注入3D几何信息，使其成为一个专门为解决复杂3D分子相互作用问题而设计的、高效且硬件友好的深度学习架构。
